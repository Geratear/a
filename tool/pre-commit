#!/usr/bin/env python3
import sys
import os
import re
from subprocess import getoutput

cmd = 'git diff-index --cached --name-only --diff-filter=ACMRD HEAD -- post | grep -P "20.+.md$"'
output = getoutput(cmd).strip()


def basename(path):
    filename = os.path.split(path)[1]
    return os.path.splitext(filename)[0]

if output:
    indexFile = 'post/0/0.md'
    blogMd = open(indexFile)
    blogs = {}
    for line in blogMd:
        m = re.match(
            '^- \[(?P<title>.+)\]\(#/(?P<path>.+md)\) - (?P<date>\d+)', line)
        if m:
            title = m.group('title')
            path = m.group('path')
            date = m.group('date')
            blogs[path] = [title, path, date]
    for path in output.split('\n'):
        date = basename(path)[:8]
        if os.path.exists(path) and os.stat(path).st_size:
            title = next(open(path))[2:].strip()
            blogs[path] = [title, path, date]
        else:
            blogs.pop(path, None)

    with open(indexFile, 'w') as fp:
        fp.write(f'# 目录\n')
        for title, path, date in sorted(blogs.values(), key=lambda v: v[2], reverse=True):
            article = f'- [{title}](#/{path}) - {date}'
            print(article)
            fp.write(article+'\n')
    getoutput(f'git add {indexFile}')
